# 狗吠检测系统架构说明文档

## 文档概述
- **文档版本**: 1.0
- **作者**: Kend by Gxzl
- **日期**: 2025年11月20日
- **目的**: 本文档描述狗吠检测系统的整体架构，焦点是音频流的处理管道。架构强调高召回率（>95%检测狗吠事件）、低延迟（<300ms端到端响应）和实时性，适合ESP32-S3嵌入式设备。文档不包括模块内部实现代码细节（如算法公式或函数体），仅概述组件、数据流和关键注意点。
- **适用范围**: 止吠器应用（检测狗吠并响应）。硬件为ESP32-S3，软件基于FreeRTOS + Arduino + ESP-DSP + TensorFlow Lite。
- **硬件说明**: 系统运行在双核MCU，高优先级任务处理实时音频。内存限~320KB，使用队列解耦。狗吠特征：短促爆发（0.15-0.4s），频段500-5000Hz。

## 系统架构概述
系统采用生产者-消费者管道模型（pipeline），从音频采集到最终响应，共4个主要组件（3个任务 + 1硬件层）。架构简化多级缓冲，只用3个队列解耦，确保高可用（DMA连续生产）和高召回（低阈值VAD + 重叠滑窗 + 事件融合）,形成一个解耦的流水线。
- **设计原则**:
  - **高召回**: VAD算法初筛，重叠滑窗防事件“切开”，允许假阳通过（后续tinyml模型过滤）。
  - **低延迟**: VAD算法做初筛，消费生产队列，筛选出类似狗吠事件，生产到event队列。
  - **鲁棒性**: 音频队列满时丢老数据（优先新事件），丢帧监控，指数backoff防CPU高。
  - **资源优化**: 双核分配（核0: 生产/VAD，核1: TinyML/声纹）。ESP-DSP加速FFT/MFCC。
  - **扩展性**:  模块解耦，数据流通过队列传递。

- **整体数据流**:
  - DMA采集 → 音频队列 → VAD/滑窗预筛 → 事件队列 → TinyML分类 + 声纹验证 → 响应。

- **模块设计**:

| 模块                        | 功能               | 输入                        | 输出                        | 特点                   |
| ------------------------- | ---------------- | ------------------------- | ------------------------- | -------------------- |
| **DMA Producer**          | I2S + DMA 连续采集音频 | 麦克风 PCM 音频                | 音频队列 | 高速、低延迟、可监控丢帧         |
| **VAD Event Detection** | 滑窗 + 能量/频率检测     | 音频队列 | Event Buffer（潜在狗吠区域）      | 高召回、低计算量、滑窗重叠处理      |
| **MFCC + TinyML**         | 狗吠分类             | Event Buffer              | Bark Buffer（确认狗吠事件）       | 模型轻量、高召回、ESP32 可实时推理 |
| **Log-Mel + TinyML** | 声纹/精细分类          | Bark Buffer 或原始 PCM       | Dog ID / 验证结果             | 高精度，仅在条件满足时运行       |




## 组件描述
1. **DMA生产者 (DMA Producer)**:
   - 作用: 连续采集PCM音频（16kHz, mono, int16_t），初步滤波（DC removal）。
   - 输入: I2S麦克风硬件。
   - 输出: 批量PCM块（256样本/batch）到音频队列（FreeRTOS Queue）。
   - 注意: 高优先级任务，非阻塞。队列满丢老batch（高召回优先新）。监控丢帧率每小时丢帧<1%。

2. **VAD + 滑窗预筛 (VAD + Sliding Window Pre-filter)**:
   - 作用: 消费音频队列，先VAD筛有声段，然后滑窗分析潜在狗吠。融合连续窗防切开。
   - 输入: PCM批次从音频队列。
   - 输出: 潜在狗吠事件（struct {start_sample, end_sample, pre_score}）到潜在事件队列（suspect_queue）。
   - 注意: 单任务，中优先级。VAD阈低（RMS>0.005），滑窗重叠75%（步50ms）。融合: 连续窗能量>阈→merge事件。高召回允许假阳。

3. **TinyML分类狗吠 + 声纹验证 (TinyML Classifier + Voiceprint Verification)**:
   - 作用: 消费潜在事件，先TinyML确认狗吠，然后声纹匹配模板库。
   - 输入: 潜在事件从suspect_queue。
   - 输出: 确认匹配结果（dog_id, confidence），触发响应。
   - 注意: 单任务，低优先级。TinyML阈0.6（高召回）。声纹用cos sim，库小（<10模板）。合并减少延迟。

4. **响应机制 (Response Mechanism)**:
   - 作用: 根据匹配结果触发对应的动作。
   - 输入: 确认事件。
   - 输出: 硬件响应。
   - 注意: 可集成到声纹任务末尾，或独立事件处理器。


## 数据流与交互
- **音频流图描述** (见流程图):
  1. DMA采集PCM → 音频队列。
  2. VAD消费队列 → 检测有声 → 滑窗分析 → 融合事件 → 事件队列。
  3. TinyML消费事件 → MFCC + 推理 → 确认狗吠 → 声纹匹配 → 响应。

- **关键交互**:
  - 同步: 队列阻塞（xQueueReceive MAX_DELAY），mutex保护共享。
  - 异常: 队列满→丢老（日志）。切开防: 融合逻辑在VAD/滑窗。
  - 监控: 每10s任务log丢帧/CPU（esp_get_cpu_usage）。



## 流程图

[麦克风] 
    │
    ▼
[DMA Producer]
(PCM音频流写音频队列)
    │
    ▼
[VAD & Event Detection]
(滑窗 + 能量/频率检测)
    │
    ▼
[Event Buffer] ---> [MFCC + TinyML]
                         │
                         ▼
                     [Bark Buffer]
                         │
                         ▼
              [Log-Mel + TinyML / 声纹]
                         │
                         ▼
                     [最终输出]
                   (狗叫事件+ID)

## 注意事项
- **高召回优化**: 低阈 + 重叠 + 融合，测试数据集调参。
- **低延迟**: 队列深度小，DSP加速。
- **资源**: 双核，PSRAM缓冲。监控heap/CPU。
- **测试**: 分模块（DMA采集准？VAD召回高？）。端到端: 狗吠clip测F1。
- **扩展**: 加噪声抑制（WebRTC）到VAD前。