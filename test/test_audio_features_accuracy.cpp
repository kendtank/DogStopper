// /*
//  * 测试音频特征提取算法的准确性
//     * 使用Unity测试框架
//     * 覆盖算法的准确性验证
//     * 确保算法与python算法输出的一致性
//     * 要求误差不低于阈值%
// */

// #include "unity.h"
// #include "audio_features.h"
// #include <string.h>
// #include <math.h>
// #include <Arduino.h>

// // 从Python脚本获取的算法实现的输出
// static const float reference_logmel[18*40] = {
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -85.680348f, -79.194923f, -74.683959f, -65.883377f, -44.740928f, -19.244287f, -15.060845f, -25.782732f,
//     -57.929648f, -68.200120f, -79.630280f, -82.470570f, -90.259369f, -91.974919f, -97.147053f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
//     -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f, -100.000000f,
// };


// static int16_t test_input[INPUT_SAMPLES];
// static float test_output[LOGMEL_SIZE];

// void setUp(void) {
//     memset(test_input, 0, sizeof(test_input));
//     memset(test_output, 0, sizeof(test_output));
//     feature_extractor_free();
// }

// void tearDown(void) {
//     feature_extractor_free();
// }

// // 生成与Python脚本中相同的测试信号
// void generate_test_signal(int16_t* buffer, int length, float frequency, int sample_rate) {
//     const float amplitude = 0.3f * 32768.0f;  // 30%幅度
//     for (int i = 0; i < length; i++) {
//         float t = (float)i / sample_rate;
//         buffer[i] = (int16_t)(amplitude * sinf(2.0f * M_PI * frequency * t));
//     }
// }

// // 计算最大绝对误差
// float calculate_max_absolute_error(const float* ref, const float* actual, int size) {
//     float max_error = 0.0f;
//     for (int i = 0; i < size; i++) {
//         float error = fabsf(ref[i] - actual[i]);
//         if (error > max_error) {
//             max_error = error;
//         }
//     }
//     return max_error;
// }

// // 计算均方根误差
// float calculate_rmse(const float* ref, const float* actual, int size) {
//     float sum_squared_error = 0.0f;
//     for (int i = 0; i < size; i++) {
//         float error = ref[i] - actual[i];
//         sum_squared_error += error * error;
//     }
//     return sqrtf(sum_squared_error / size);
// }

// // 精度测试
// void test_logmel_accuracy_sine_wave_500hz(void) {
//     // 生成与Python脚本中完全相同的测试信号
//     generate_test_signal(test_input, INPUT_SAMPLES, 500.0f, 16000);
    
//     // 执行C实现的Log-Mel计算
//     int result = compute_logmel_200ms(test_input, test_output);
//     TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);
    
//     // 验证所有帧的所有特征
//     const int total_features = NUM_FRAMES * N_MEL_BINS;  // 18 * 40 = 720
//     float max_error = calculate_max_absolute_error(reference_logmel, test_output, total_features);
//     float rmse = calculate_rmse(reference_logmel, test_output, total_features);
    
//     // 设置严格的误差阈值
//     const float max_error_threshold = 0.001f;  // 最大绝对误差不超过0.001
//     const float rmse_threshold = 0.0005f;      // 均方根误差不超过0.0005
    
//     char error_msg[100];
//     sprintf(error_msg, "最大绝对误差 %.6f 超过阈值 %.6f", max_error, max_error_threshold);
//     TEST_ASSERT_TRUE_MESSAGE(max_error < max_error_threshold, error_msg);
    
//     sprintf(error_msg, "均方根误差 %.6f 超过阈值 %.6f", rmse, rmse_threshold);
//     TEST_ASSERT_TRUE_MESSAGE(rmse < rmse_threshold, error_msg);
    
// #if defined(DEBUG_FEATURES) && DEBUG_FEATURES
//     Serial.printf("[精度测试] 500Hz正弦波: 最大误差=%.6f, 均方根误差=%.6f\n", max_error, rmse);
// #endif
// }

// // 静音信号测试
// void test_logmel_accuracy_silence(void) {
//     // 全零输入（静音信号）
//     memset(test_input, 0, sizeof(test_input));
    
//     int result = compute_logmel_200ms(test_input, test_output);
//     TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);
    
//     // 静音信号应该产生接近-100的值（因为使用了1e-10的最小能量）
//     float expected_value = -100.0f;  // 10 * log10(1e-10) = -100
//     float tolerance = 0.001f;
    
//     for (int i = 0; i < 10; i++) {  // 检查前10个值
//         char error_msg[100];
//         sprintf(error_msg, "静音信号输出 %.6f 与期望值 %.6f 差异超过阈值 %.6f", 
//                 test_output[i], expected_value, tolerance);
//         TEST_ASSERT_FLOAT_WITHIN_MESSAGE(tolerance, expected_value, test_output[i], error_msg);
//     }
// }

// int runUnityTests(void) {
//     UNITY_BEGIN();
    
//     RUN_TEST(test_logmel_accuracy_sine_wave_500hz);
//     RUN_TEST(test_logmel_accuracy_silence);
    
//     return UNITY_END();
// }

// void setup() {
//     Serial.begin(115200);
//     delay(2000);
//     runUnityTests();
// }

// void loop() {
//     delay(1000);
// }

// // pio test -f "test_audio_features_accuracy" -v 