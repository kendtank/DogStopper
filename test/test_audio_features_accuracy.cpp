/*
 * 测试音频特征提取算法的准确性
    * 使用Unity测试框架
    * 覆盖算法的准确性验证
    * 确保算法与python算法输出的一致性
    * 要求误差不低于阈值%
*/

#include "unity.h"
#include "audio_features.h"
#include <string.h>
#include <math.h>
#include <Arduino.h>


static const float frame_mel_db_py[1152] = {
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
};


static int16_t test_input[INPUT_SAMPLES];
static float test_output[LOGMEL_SIZE];



// 生成与Python脚本中相同的测试信号
void generate_test_signal(int16_t* buffer, int length, float frequency, int sample_rate) {
    const float amplitude = 0.3f * 32768.0f;  // 30%幅度
    for (int i = 0; i < length; i++) {
        float t = (float)i / sample_rate;
        buffer[i] = (int16_t)(amplitude * sinf(2.0f * M_PI * frequency * t));
    }
}


// 计算最大绝对误差
float calculate_max_absolute_error(const float* ref, const float* actual, int size) {
    float max_error = 0.0f;
    for (int i = 0; i < size; i++) {
        float error = fabsf(ref[i] - actual[i]);
        if (error > max_error) {
            max_error = error;
        }
    }
    return max_error;
}


// 计算均方根误差
float calculate_rmse(const float* ref, const float* actual, int size) {
    float sum_squared_error = 0.0f;
    for (int i = 0; i < size; i++) {
        float error = ref[i] - actual[i];
        sum_squared_error += error * error;
    }
    return sqrtf(sum_squared_error / size);
}



// 精度测试
void test_logmel_accuracy_sine_wave_500hz(void) {
    bool is_init = init_feature_buffers();
    TEST_ASSERT_TRUE(is_init);

    // 生成与Python脚本中完全相同的测试信号
    generate_test_signal(test_input, INPUT_SAMPLES, 500.0f, 16000);
    
    // 执行C实现的Log-Mel计算
    int result = compute_logmel_200ms(test_input, test_output);
    TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);
    
    // 验证所有帧的所有特征
    const int total_features = NUM_FRAMES * N_MEL_BINS;  // 18 * 64 
    float max_error = calculate_max_absolute_error(frame_mel_db_py, test_output, total_features);
    float rmse = calculate_rmse(frame_mel_db_py, test_output, total_features);
    
    // 设置严格的误差阈值
    const float max_error_threshold = 0.001f;  // 最大绝对误差不超过0.001
    const float rmse_threshold = 0.0005f;      // 均方根误差不超过0.0005
    
    char error_msg[100];
    snprintf(error_msg, "Max absolute error %.6f exceeds threshold %.6f", max_error, max_error_threshold);
    TEST_ASSERT_TRUE_MESSAGE(max_error < max_error_threshold, error_msg);
    
    snprintf(error_msg, "Max absolute error %.6f exceeds threshold %.6f", rmse, rmse_threshold);
    TEST_ASSERT_TRUE_MESSAGE(rmse < rmse_threshold, error_msg);
    
#if defined(DEBUG_FEATURES) && DEBUG_FEATURES
    Serial.printf("[精度测试] 500Hz正弦波: 最大误差=%.6f, 均方根误差=%.6f\n", max_error, rmse);
#endif
}


// 静音信号测试
void test_logmel_accuracy_silence(void) {
    // 全零输入（静音信号）
    memset(test_input, 0, sizeof(test_input));
    
    int result = compute_logmel_200ms(test_input, test_output);
    TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);
    
    // 静音信号应该产生接近-100的值（因为使用了1e-10的最小能量）
    float expected_value = -100.0f;  // 10 * log10(1e-10) = -100
    float tolerance = 0.001f;
    
    for (int i = 0; i < 10; i++) {  // 检查前10个值
        char error_msg[100];
        snprintf(error_msg, "静音信号输出 %.6f 与期望值 %.6f 差异超过阈值 %.6f", 
                test_output[i], expected_value, tolerance);
        TEST_ASSERT_FLOAT_WITHIN_MESSAGE(tolerance, expected_value, test_output[i], error_msg);
    }
}



void setUp(void) {
}

void tearDown(void) {
}

int runUnityTests(void) {
    UNITY_BEGIN();
    
    RUN_TEST(test_logmel_accuracy_sine_wave_500hz);
    RUN_TEST(test_logmel_accuracy_silence);
    
    return UNITY_END();
}

void setup() {
    Serial.begin(115200);
    delay(2000);
    runUnityTests();
}

void loop() {
    delay(1000);
}