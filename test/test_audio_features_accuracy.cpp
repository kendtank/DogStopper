/*
 * 测试音频特征提取算法的准确性
    * 使用Unity测试框架
    * 覆盖算法的准确性验证
    * 确保算法与python算法输出的一致性
    * 要求误差不低于阈值%
*/

#include "unity.h"
#include "audio_features.h"
#include <string.h>
#include <math.h>
#include <Arduino.h>
#include "../python/test_data.h"


static const float frame_mel_db_py[1152] = {
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -60.25464630, -57.28963852, -51.94388580, -52.66822815, -49.32366180, -39.14432907, -38.46017456, -24.23806000,
    -6.50161457, 10.86481285, 13.13775921, 6.18362808, -12.49108696, -36.01153183, -37.94219589, -42.84332275,
    -53.74969864, -52.71778870, -55.13353348, -65.35378265, -62.19490814, -63.93745804, -72.22119141, -68.81438446,
    -72.64733124, -76.80410767, -75.43973541, -80.00000000, -79.75550842, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
    -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000, -80.00000000,
};


static float test_input[INPUT_SAMPLES];
static float test_output[LOGMEL_SIZE];



// 生成与Python脚本中相同的测试信号
void generate_test_signal(int16_t* buffer, int length, float frequency, int sample_rate) {
    const float amplitude = 0.3f * 32768.0f;  // 30%幅度
    for (int i = 0; i < length; i++) {
        float t = (float)i / sample_rate;
        buffer[i] = (int16_t)(amplitude * sinf(2.0f * M_PI * frequency * t));
    }
}


// 计算最大绝对误差
float calculate_max_absolute_error(const float* ref, const float* actual, int size) {
    float max_error = 0.0f;
    for (int i = 0; i < size; i++) {
        float error = fabsf(ref[i] - actual[i]);
        if (error > max_error) {
            max_error = error;
        }
    }
    return max_error;
}


// 计算均方根误差
float calculate_rmse(const float* ref, const float* actual, int size) {
    float sum_squared_error = 0.0f;
    for (int i = 0; i < size; i++) {
        float error = ref[i] - actual[i];
        sum_squared_error += error * error;
    }
    return sqrtf(sum_squared_error / size);
}



// 精度测试
void test_logmel_accuracy_sine_wave_500hz(void) {
    bool is_init = init_feature_buffers();
    TEST_ASSERT_TRUE(is_init);

    // 生成与Python脚本中完全相同的测试信号
    // generate_test_signal(test_input, INPUT_SAMPLES, 500.0f, 16000);
    // 直接使用python生成的数据头文件
    // test_input = test_input_signal;


    // 执行C实现的Log-Mel计算
    int result = compute_logmel_from_float(test_input_signal, test_output);
    TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);

    // 打印logmel特征的前10bin数据和后十个bin的数据
    Serial.printf("[精度测试] 500Hz正弦波: 前10bin数据:\n");
    for (int i = 0; i < 10; i++) {
        Serial.printf("%.6f ", test_output[i]);
    }
    Serial.printf("\n[精度测试] 500Hz正弦波: 后十个bin数据:\n");
    for (int i = NUM_FRAMES * N_MEL_BINS - 10; i < NUM_FRAMES * N_MEL_BINS; i++) {
        Serial.printf("%.6f ", test_output[i]);
    }
    // python logmel特征的前10bin数据和后十个bin数据
    Serial.printf("\n[精度测试] 500Hz正弦波: python-bin前10个数据:\n");
    for (int i = 0; i < 10; i++) {
        Serial.printf("%.6f ", frame_mel_db_py[i]);
    }
    Serial.printf("\n[精度测试] 500Hz正弦波: python-bin后十个数据:\n");
    for (int i = NUM_FRAMES * N_MEL_BINS - 10; i < NUM_FRAMES * N_MEL_BINS; i++) {
        Serial.printf("%.6f ", frame_mel_db_py[i]);
    }
    
    // 验证所有帧的所有特征
    const int total_features = NUM_FRAMES * N_MEL_BINS;  // 18 * 64 
    float max_error = calculate_max_absolute_error(frame_mel_db_py, test_output, total_features);
    float rmse = calculate_rmse(frame_mel_db_py, test_output, total_features);

    Serial.printf("[精度测试] 500Hz正弦波: 最大绝对误差=%.6f, 均方根误差=%.6f\n", max_error, rmse);   //   500Hz正弦波: 最大绝对误差=0.002594, 均方根差=0.000350
    
    // 设置严格的误差阈值
    const float max_error_threshold = 0.01f;  // 最大绝对误差不超过0.001  db值在0.01已经非常优秀
    const float rmse_threshold = 0.001f;      // 均方根误差不超过0.001
    
    char error_msg[100];
    sprintf(error_msg, "Max absolute error %.6f exceeds threshold %.6f", max_error, max_error_threshold);
    TEST_ASSERT_TRUE_MESSAGE(max_error < max_error_threshold, error_msg);
    
    sprintf(error_msg, "Max absolute error %.6f exceeds threshold %.6f", rmse, rmse_threshold);
    TEST_ASSERT_TRUE_MESSAGE(rmse < rmse_threshold, error_msg);

}


// 静音信号测试
void test_logmel_accuracy_silence(void) {
    // 全零输入（静音信号）
    static float test_input[INPUT_SAMPLES] = {0.0f}; // 全零静音
    float test_output[NUM_FRAMES * N_MEL_BINS];
    
    int result = compute_logmel_from_float(test_input, test_output);
    TEST_ASSERT_EQUAL_INT(NUM_FRAMES, result);
    
    // 静音信号应该产生接近-80的值， tb是-80
    float expected_value = -80.0f;  // 
    float tolerance = 0.001f;
    
    for (int i = 0; i < 10; i++) {  // 检查前10个值
        char error_msg[100];
        sprintf(error_msg, "test_input %.6f exceeds %.6f tolerance %.6f", 
                test_output[i], expected_value, tolerance);
        TEST_ASSERT_FLOAT_WITHIN_MESSAGE(tolerance, expected_value, test_output[i], error_msg);
    }
}



void setUp(void) {
}

void tearDown(void) {
}

int runUnityTests(void) {
    UNITY_BEGIN();
    
    RUN_TEST(test_logmel_accuracy_sine_wave_500hz);
    RUN_TEST(test_logmel_accuracy_silence);
    
    return UNITY_END();
}

void setup() {
    Serial.begin(115200);
    delay(2000);
    runUnityTests();
}

void loop() {
    delay(1000);
}



/*
[MEM] 堆内存剩余: 308844 bytes
[MEM] PSRAM总大小: 8386215 bytes
[MEM] PSRAM可用: 8333123 bytes
frames_win: 18 frames
fft_power_init: 初始化完成, FFT大小 = 512
fft_power_compute: 功率谱计算完成
[MEM] 堆内存剩余: 301692 bytes
[MEM] PSRAM总大小: 8386215 bytes
[MEM] PSRAM可用: 8333123 bytes
[TIME] compute_logmel_from_float 执行耗时: 72617 us (72.617 ms)
[精度测试] 500Hz正弦波: 前10bin数据:
-60.254292 -57.289825 -51.944088 -52.668262 -49.323544 -39.144321 -38.460197 -24.238068 -6.501614 10.864816 
[精度测试] 500Hz正弦波: 后十个bin数据:
-80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 
[精度测试] 500Hz弦波: python-bin前10个数据:
-60.254646 -57.289639 -51.943886 -52.668228 -49.323662 -39.144329 -38.460175 -24.238060 -6.501615 10.864813 
[精度测试] 500Hz正弦波: python-bin后十个数据:
-80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 -80.000000 [精度测试] 500Hz正弦波: 最大绝对误差=0.002594, 均方根差=0.000350
test/test_audio_features_accuracy.cpp:292:test_logmel_accuracy_sine_wave_500hz:PASS
[MEM] 堆内存剩余: 301428 bytes
[MEM] PSRAM总大小: 8386215 bytes
[MEM] PSRAM可用: 8333123 bytes
frames_win: 18 frames
fft_power_init: 已初始化，无需重复
fft_power_compute: 功率谱计算完成
[MEM] 堆内存剩余: 301428 bytes
[MEM] PSRAM总大小: 8386215 bytes
[MEM] PSRAM可用: 8333123 bytes
[TIME] compute_logmel_from_float 执行耗时: 69814 us (69.814 ms)
test/test_audio_features_accuracy.cpp:293:test_logmel_accuracy_silence:PASS

-----------------------
2 Tests 0 Failures 0 Ignored 
OK

*/