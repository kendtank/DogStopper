# ESP32-S3 + PlatformIO 开发笔记

## 一、基本信息
- 系统：ubuntu22.04
- 芯片型号：ESP32-S3
- 开发板：ESP32-S3-DevKitC-1-N16R8
- IDE/工具：VSCode
- 框架：Arduino

## 二、遇到的问题
**1. 串口打印无输出**
   - 问题描述：platformio连接开发板, 调用serial.print()打印数据，串口监测不到数据
   - 解决方法：在platformio.ini中添加如下代码：
   ```
   upload_speed = 921600
   ```
   并且上传镜像之后打开串口监控的控制台，再按下reset按键，就会显示打印的数据


**2. 板子无法启用PSRAM内存**
   - 问题描述：开发板选择[Espressif ESP32-S3-DevKitC-1-N8 (8 MB QD, No PSRAM)]之后无法启用PSRAM内存
   - 解决方法：由于板子是N16R8型号，platformio板子中没有这个型号，只能使用[Espressif ESP32-S3-DevKitC-1-N8 (8 MB QD, No PSRAM)]， 然后再platformio.ini中添加如下配置：
   ```
   platform = espressif32
   board    = esp32-s3-devkitc-1    ; 选通用 S3 DevKitC
   framework= arduino
   ; --- Flash & PSRAM 接口配置 ---
   board_build.flash_mode    = qio       ;  指定FLASH和PSRAM的运行模式 Flash 用 QIO
   board_build.arduino.memory_type = qio_opi  ; Flash QIO + PSRAM Octal
   board_build.psram_type    = opi       ; PSRAM 用 Octal mode
   ; --- 大小定义 ---
   board_upload.flash_size   = 16MB
   board_upload.maximum_size = 16777216  ; 一定要和 16MB 对齐
   board_build.partitions    = default_16MB.csv  ; 用 16MB 分区表
   ; 指定为16MB的FLASH分区表
   board_build.arduino.partitions = default_16MB.csv
   ; --- 启用 PSRAM 宏 ---
   board_build.extra_flags   = -DBOARD_HAS_PSRAM
   ```
  配置完成之后，重新拔插板子，再编译测试是否可以申请PSRAM的代码进行测试。
  

**3. platformio无法使用TensorflowLite for MicroController插件**
   - 问题描述：platformio无法使用TFLM插件
   - 解决方法：添加官方的tflm git仓库运行测试，会提示缺少很多的第三方库，一般是flatbuffers以及别的库，手动去下载很麻烦，但是Arduino IDE是有官方的ESP32_TFLM插件的全称[TensorFlowLite_ESP32],所以可以尝试使用Arduino IDE下载插件，再把源码拷贝到lib目录中，引入如下一行代码：
   ```
   #include <TensorFlowLite_ESP32.h>
   ```
   添加完之后，就可以使用TFLM插件了
   注意：正常的tf-lite的代码还是需要自己引入的。

**4. 快速傅里叶变换(FFT)计算运行速度很慢**
   - 问题描述：手写FFT算法，因为需要大量的复数运算，导致运行速度很慢(测试10s 16k的音频需要70s左右)
   - 解决方法：采用ESP的dsp库进行加速，采用dsps_fft2r进行快速傅里叶变换，速度大大提升， 可以详细查看[ESP32-DSP-Library](https://github.com/espressif/esp-dsp)。

**5. 使用ESP的dsp库加速FFT计算, 遇到空指针错误**
   - 问题描述：使用dsps_fft2r_fc32(fft_buf, N_FFT);进行快速傅里叶变换，但是运行过程中会报空指针错误
   - 解决方法：在使用dsps_fft2r_fc32()之前，必须调用dsps_fft2r_init_fc32(NULL, CONFIG_DSP_MAX_FFT_SIZE);进行初始化，否则在申请内存空间时会报空指针错误

**6. 使用unity进行单元测试遇到的问题**
   - 问题描述：使用unity进行单元测试，遇到了很多的问题
   - 解决方法：platformio创建项目会生成一个test 目录，里面就是为了存放了unity的测试代码，在test目录下创建一个测试的cpp文件，按照main.cpp的格式进行编码，运行项目会报错，找不到自己写的主功能代码，因为头文件默认是指定的include目录，但是unity测试默认不编译src目录下的代码。所以需要在platformio.ini中指定：
   ```
   test_framework = unity
   test_build_project_src = yes  
   ```
   unity测试默认不编译src目录下的代码，启用此选项以编译src目录下的代码， 但是src中有main.cpp, 需要屏幕其中的setup和loop函数, 这样才能进行烧录测试。否则会报错找到两个setup和loop函数。

**7. 使用platformio进行debug遇到问题**
   - 问题描述：使用platformio进行debug报异常
   - 解决方法：配置platformio.ini文件，添加如下代码：
   ```
   debug_tool = esp-builtin
   debug_init_break = tbreak setup
   build_type = debug
   ```
   添加了esp-builtin调试工具，添加了debug_init_break，指定了在setup函数开始时断点，添加了build_type = debug，指定了debug模式，最后打开终端执行：
   ```
   curl -fsSL https://raw.githubusercontent.com/platformio/platformio-core/develop/platformio/assets/system/99-platformio-udev.rules | sudo tee /etc/udev/rules.d/99-platformio-udev.rules
   sudo service udev restart
   ```
   重新拔插板子，这样platformio就会在setup函数开始时断点，然后进行debug。使用vsode进行正常的板子层级别的debug功能
